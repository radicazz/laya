name: Documentation

on:
  push:
    branches: [ master ]
    paths:
      - 'docs/**'
      - 'include/**'
      - 'src/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'docs/**'
      - 'include/**'
      - 'src/**'
      - 'README.md'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          doxygen \
          graphviz \
          python3 \
          python3-pip \
          plantuml \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-fonts-recommended

    - name: Install Python documentation tools
      run: |
        pip3 install \
          mkdocs \
          mkdocs-material \
          mkdocs-mermaid2-plugin \
          pymdown-extensions \
          markdown-include

    - name: Setup Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/configure-pages@v4

    - name: Create Doxygen configuration
      run: |
        cat > Doxyfile << 'EOF'
        # Doxygen configuration for laya
        PROJECT_NAME           = "laya"
        PROJECT_NUMBER         = "v0.0.1"
        PROJECT_BRIEF          = "Modern C++20 wrapper for SDL3"
        PROJECT_LOGO           =

        OUTPUT_DIRECTORY       = docs-build/doxygen
        CREATE_SUBDIRS         = NO
        ALLOW_UNICODE_NAMES    = NO
        OUTPUT_LANGUAGE        = English
        BRIEF_MEMBER_DESC      = YES
        REPEAT_BRIEF           = YES
        ABBREVIATE_BRIEF       =
        ALWAYS_DETAILED_SEC    = NO
        INLINE_INHERITED_MEMB  = NO
        FULL_PATH_NAMES        = YES
        STRIP_FROM_PATH        =
        STRIP_FROM_INC_PATH    =
        SHORT_NAMES            = NO
        JAVADOC_AUTOBRIEF      = YES
        QT_AUTOBRIEF           = NO
        MULTILINE_CPP_IS_BRIEF = NO
        INHERIT_DOCS           = YES
        SEPARATE_MEMBER_PAGES  = NO
        TAB_SIZE               = 4
        ALIASES                =
        TCL_SUBST              =
        OPTIMIZE_OUTPUT_FOR_C  = NO
        OPTIMIZE_OUTPUT_JAVA   = NO
        OPTIMIZE_FOR_FORTRAN   = NO
        OPTIMIZE_OUTPUT_VHDL   = NO
        EXTENSION_MAPPING      =
        MARKDOWN_SUPPORT       = YES
        TOC_INCLUDE_HEADINGS   = 0
        AUTOLINK_SUPPORT       = YES
        BUILTIN_STL_SUPPORT    = YES
        CPP_CLI_SUPPORT        = NO
        SIP_SUPPORT            = NO
        IDL_PROPERTY_SUPPORT   = YES
        DISTRIBUTE_GROUP_DOC   = NO
        GROUP_NESTED_COMPOUNDS = NO
        SUBGROUPING            = YES
        INLINE_GROUPED_CLASSES = NO
        INLINE_SIMPLE_STRUCTS  = NO
        TYPEDEF_HIDES_STRUCT   = NO
        LOOKUP_CACHE_SIZE      = 0

        # Build related configuration options
        EXTRACT_ALL            = YES
        EXTRACT_PRIVATE        = NO
        EXTRACT_PRIV_VIRTUAL   = NO
        EXTRACT_PACKAGE        = NO
        EXTRACT_STATIC         = YES
        EXTRACT_LOCAL_CLASSES  = YES
        EXTRACT_LOCAL_METHODS  = NO
        EXTRACT_ANON_NSPACES   = NO
        HIDE_UNDOC_MEMBERS     = NO
        HIDE_UNDOC_CLASSES     = NO
        HIDE_FRIEND_COMPOUNDS  = NO
        HIDE_IN_BODY_DOCS      = NO
        INTERNAL_DOCS          = NO
        CASE_SENSE_NAMES       = YES
        HIDE_SCOPE_NAMES       = NO
        HIDE_COMPOUND_REFERENCE= NO
        SHOW_INCLUDE_FILES     = YES
        SHOW_GROUPED_MEMB_INC  = NO
        FORCE_LOCAL_INCLUDES   = NO
        INLINE_INFO            = YES
        SORT_MEMBER_DOCS       = YES
        SORT_BRIEF_DOCS        = NO
        SORT_MEMBERS_CTORS_1ST = NO
        SORT_GROUP_NAMES       = NO
        SORT_BY_SCOPE_NAME     = NO
        STRICT_PROTO_MATCHING  = NO
        GENERATE_TODOLIST      = YES
        GENERATE_TESTLIST      = YES
        GENERATE_BUGLIST       = YES
        GENERATE_DEPRECATEDLIST= YES
        ENABLED_SECTIONS       =
        MAX_INITIALIZER_LINES  = 30
        SHOW_USED_FILES        = YES
        SHOW_FILES             = YES
        SHOW_NAMESPACES        = YES
        FILE_VERSION_FILTER    =
        LAYOUT_FILE            =
        CITE_BIB_FILES         =

        # Configuration options related to warning and progress messages
        QUIET                  = NO
        WARNINGS               = YES
        WARN_IF_UNDOCUMENTED   = YES
        WARN_IF_DOC_ERROR      = YES
        WARN_NO_PARAMDOC       = NO
        WARN_AS_ERROR          = NO
        WARN_FORMAT            = "$file:$line: $text"
        WARN_LOGFILE           =

        # Configuration options related to the input files
        INPUT                  = include src README.md
        INPUT_ENCODING         = UTF-8
        FILE_PATTERNS          = *.c *.cc *.cxx *.cpp *.c++ *.java *.ii *.ixx *.ipp *.i++ *.inl *.idl *.ddl *.odl *.h *.hh *.hxx *.hpp *.h++ *.cs *.d *.php *.php4 *.php5 *.phtml *.inc *.m *.markdown *.md *.mm *.dox *.py *.pyw *.f90 *.f95 *.f03 *.f08 *.f *.for *.tcl *.vhd *.vhdl *.ucf *.qsf
        RECURSIVE              = YES
        EXCLUDE                =
        EXCLUDE_SYMLINKS       = NO
        EXCLUDE_PATTERNS       = */build/* */external/*
        EXCLUDE_SYMBOLS        =
        EXAMPLE_PATH           = examples
        EXAMPLE_PATTERNS       = *
        EXAMPLE_RECURSIVE      = NO
        IMAGE_PATH             = docs/images
        INPUT_FILTER           =
        FILTER_PATTERNS        =
        FILTER_SOURCE_FILES    = NO
        FILTER_SOURCE_PATTERNS =
        USE_MDFILE_AS_MAINPAGE = README.md

        # Configuration options related to source browsing
        SOURCE_BROWSER         = YES
        INLINE_SOURCES         = NO
        STRIP_CODE_COMMENTS    = YES
        REFERENCED_BY_RELATION = NO
        REFERENCES_RELATION    = NO
        REFERENCES_LINK_SOURCE = YES
        SOURCE_TOOLTIPS        = YES
        USE_HTAGS              = NO
        VERBATIM_HEADERS       = YES
        CLANG_ASSISTED_PARSING = NO
        CLANG_OPTIONS          =
        CLANG_DATABASE_PATH    =

        # Configuration options related to the alphabetical class index
        ALPHABETICAL_INDEX     = YES
        COLS_IN_ALPHA_INDEX    = 5
        IGNORE_PREFIX          =

        # Configuration options related to the HTML output
        GENERATE_HTML          = YES
        HTML_OUTPUT            = html
        HTML_FILE_EXTENSION    = .html
        HTML_HEADER            =
        HTML_FOOTER            =
        HTML_STYLESHEET        =
        HTML_EXTRA_STYLESHEET  =
        HTML_EXTRA_FILES       =
        HTML_COLORSTYLE_HUE    = 220
        HTML_COLORSTYLE_SAT    = 100
        HTML_COLORSTYLE_GAMMA  = 80
        HTML_TIMESTAMP         = NO
        HTML_DYNAMIC_MENUS     = YES
        HTML_DYNAMIC_SECTIONS  = NO
        HTML_INDEX_NUM_ENTRIES = 100
        GENERATE_DOCSET        = NO
        DOCSET_FEEDNAME        = "Doxygen generated docs"
        DOCSET_BUNDLE_ID       = org.doxygen.Project
        DOCSET_PUBLISHER_ID    = org.doxygen.Publisher
        DOCSET_PUBLISHER_NAME  = Publisher
        GENERATE_HTMLHELP      = NO
        CHM_FILE               =
        HHC_LOCATION           =
        GENERATE_CHI           = NO
        CHM_INDEX_ENCODING     =
        BINARY_TOC             = NO
        TOC_EXPAND             = NO
        GENERATE_QHP           = NO
        QCH_FILE               =
        QHP_NAMESPACE          = org.doxygen.Project
        QHP_VIRTUAL_FOLDER     = doc
        QHP_CUST_FILTER_NAME   =
        QHP_CUST_FILTER_ATTRS  =
        QHP_SECT_FILTER_ATTRS  =
        QHG_LOCATION           =
        GENERATE_ECLIPSEHELP   = NO
        ECLIPSE_DOC_ID         = org.doxygen.Project
        DISABLE_INDEX          = NO
        GENERATE_TREEVIEW      = NO
        ENUM_VALUES_PER_LINE   = 4
        TREEVIEW_WIDTH         = 250
        EXT_LINKS_IN_WINDOW    = NO
        FORMULA_FONTSIZE       = 10
        FORMULA_TRANSPARENT    = YES
        USE_MATHJAX            = NO
        MATHJAX_FORMAT         = HTML-CSS
        MATHJAX_RELPATH        = https://cdn.jsdelivr.net/npm/mathjax@2
        MATHJAX_EXTENSIONS     =
        MATHJAX_CODEFILE       =
        SEARCHENGINE           = YES
        SERVER_BASED_SEARCH    = NO
        EXTERNAL_SEARCH        = NO
        SEARCHENGINE_URL       =
        SEARCHDATA_FILE        = searchdata.xml
        EXTERNAL_SEARCH_ID     =
        EXTRA_SEARCH_MAPPINGS  =

        # Configuration options related to the LaTeX output
        GENERATE_LATEX         = NO

        # Configuration options related to the RTF output
        GENERATE_RTF           = NO

        # Configuration options related to the man page output
        GENERATE_MAN           = NO

        # Configuration options related to the XML output
        GENERATE_XML           = NO

        # Configuration options related to the DOCBOOK output
        GENERATE_DOCBOOK       = NO

        # Configuration options for the AutoGen Definitions output
        GENERATE_AUTOGEN_DEF   = NO

        # Configuration options related to the Perl module output
        GENERATE_PERLMOD       = NO

        # Configuration options related to the preprocessor
        ENABLE_PREPROCESSING   = YES
        MACRO_EXPANSION        = NO
        EXPAND_ONLY_PREDEF     = NO
        SEARCH_INCLUDES        = YES
        INCLUDE_PATH           =
        INCLUDE_FILE_PATTERNS  =
        PREDEFINED             =
        EXPAND_AS_DEFINED      =
        SKIP_FUNCTION_MACROS   = YES

        # Configuration options related to external references
        TAGFILES               =
        GENERATE_TAGFILE       =
        ALLEXTERNALS           = NO
        EXTERNAL_GROUPS        = YES
        EXTERNAL_PAGES         = YES

        # Configuration options related to the dot tool
        CLASS_DIAGRAMS         = YES
        HIDE_UNDOC_RELATIONS   = YES
        HAVE_DOT               = YES
        DOT_NUM_THREADS        = 0
        DOT_FONTNAME           = Helvetica
        DOT_FONTSIZE           = 10
        DOT_FONTPATH           =
        CLASS_GRAPH            = YES
        COLLABORATION_GRAPH    = YES
        GROUP_GRAPHS           = YES
        UML_LOOK               = NO
        UML_LIMIT_NUM_FIELDS   = 10
        TEMPLATE_RELATIONS     = NO
        INCLUDE_GRAPH          = YES
        INCLUDED_BY_GRAPH      = YES
        CALL_GRAPH             = NO
        CALLER_GRAPH           = NO
        GRAPHICAL_HIERARCHY    = YES
        DIRECTORY_GRAPH        = YES
        DOT_IMAGE_FORMAT       = png
        INTERACTIVE_SVG        = NO
        DOT_PATH               =
        DOTFILE_DIRS           =
        MSCFILE_DIRS           =
        DIAFILE_DIRS           =
        PLANTUML_JAR_PATH      = /usr/share/plantuml/plantuml.jar
        PLANTUML_CFG_FILE      =
        PLANTUML_INCLUDE_PATH  =
        DOT_GRAPH_MAX_NODES    = 50
        MAX_DOT_GRAPH_DEPTH    = 0
        DOT_TRANSPARENT        = NO
        DOT_MULTI_TARGETS      = NO
        GENERATE_LEGEND        = YES
        DOT_CLEANUP            = YES
        EOF

    - name: Create MkDocs configuration
      run: |
        cat > mkdocs.yml << 'EOF'
        site_name: laya Documentation
        site_description: Modern C++20 wrapper for SDL3
        site_author: laya Contributors
        site_url: https://radicazz.github.io/laya/

        repo_name: radicazz/laya
        repo_url: https://github.com/radicazz/laya
        edit_uri: edit/master/docs/

        theme:
          name: material
          palette:
            - scheme: default
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-7
                name: Switch to dark mode
            - scheme: slate
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-4
                name: Switch to light mode
          features:
            - navigation.tabs
            - navigation.sections
            - navigation.expand
            - navigation.top
            - search.highlight
            - search.share
            - content.code.copy
            - content.action.edit

        plugins:
          - search
          - mermaid2

        markdown_extensions:
          - admonition
          - pymdownx.details
          - pymdownx.superfences:
              custom_fences:
                - name: mermaid
                  class: mermaid
                  format: !!python/name:pymdownx.superfences.fence_code_format
          - pymdownx.highlight:
              anchor_linenums: true
          - pymdownx.inlinehilite
          - pymdownx.snippets
          - pymdownx.tabbed:
              alternate_style: true
          - tables
          - toc:
              permalink: true
          - markdown_include.include:
              base_path: .

        nav:
          - Home: index.md
          - Getting Started:
            - Installation: getting-started/installation.md
            - Quick Start: getting-started/quick-start.md
            - Building: getting-started/building.md
          - Documentation:
            - Project Goals: docs/goals.md
            - Features: docs/features.md
            - Roadmap: docs/roadmap.md
            - Comparisons: docs/comparisons.md
            - Wrapping Techniques: docs/wrapping_techniques.md
          - API Reference:
            - Overview: api/index.md
            - Core: api/core.md
            - Graphics: api/graphics.md
            - Input: api/input.md
            - Audio: api/audio.md
          - Examples:
            - Hello World: examples/hello-world.md
            - Basic Graphics: examples/basic-graphics.md
            - Event Handling: examples/event-handling.md
          - Contributing:
            - Guidelines: CONTRIBUTING.md
            - Development: contributing/development.md
            - Testing: contributing/testing.md

        extra:
          social:
            - icon: fontawesome/brands/github
              link: https://github.com/radicazz/laya
        EOF

    - name: Create documentation structure
      run: |
        mkdir -p docs-build/mkdocs/docs/{getting-started,api,examples,contributing}

        # Create index page
        cat > docs-build/mkdocs/docs/index.md << 'EOF'
        # laya Documentation

        Welcome to the documentation for **laya**, a modern C++20 wrapper for SDL3.

        ## What is laya?

        laya provides a clean, type-safe, and idiomatic C++ interface for SDL3 that feels natural while preserving the full power and flexibility of the underlying C library.

        ## Key Features

        - **Zero-overhead abstractions** that compile to identical assembly as raw SDL3
        - **Modern C++ safety** with RAII, strong typing, and exception handling
        - **Complete SDL3 coverage** ensuring no functionality is lost
        - **Intuitive APIs** that feel natural to C++ developers

        ## Quick Example

        ```cpp
        #include <laya/laya.hpp>

        int main() {
            laya::context ctx;
            laya::window window("Hello laya", {800, 600});
            laya::renderer renderer(window);

            bool running = true;
            while (running) {
                for (const auto& event : laya::poll_events()) {
                    if (std::holds_alternative<laya::quit_event>(event)) {
                        running = false;
                    }
                }

                renderer.clear(laya::color::from_hex(0x2E3440));
                renderer.present();
            }

            return 0;
        }
        ```

        ## Getting Started

        - [Installation Guide](getting-started/installation.md)
        - [Quick Start Tutorial](getting-started/quick-start.md)
        - [Building from Source](getting-started/building.md)

        ## Documentation Sections

        - **[API Reference](api/index.md)** - Complete API documentation
        - **[Examples](examples/hello-world.md)** - Code examples and tutorials
        - **[Contributing](CONTRIBUTING.md)** - How to contribute to the project

        ## External Links

        - [GitHub Repository](https://github.com/radicazz/laya)
        - [SDL3 Documentation](https://wiki.libsdl.org/SDL3/)
        - [API Reference (Doxygen)](doxygen/html/index.html)
        EOF

        # Create getting started pages
        cat > docs-build/mkdocs/docs/getting-started/installation.md << 'EOF'
        # Installation

        ## Package Managers

        ### vcpkg

        ```bash
        vcpkg install laya
        ```

        ### Conan

        ```bash
        conan install laya/0.1.0@
        ```

        ## CMake Integration

        ### Using find_package

        ```cmake
        find_package(laya REQUIRED)
        target_link_libraries(your_target laya::laya)
        ```

        ### Using FetchContent

        ```cmake
        include(FetchContent)
        FetchContent_Declare(
            laya
            GIT_REPOSITORY https://github.com/radicazz/laya.git
            GIT_TAG        v0.1.0
        )
        FetchContent_MakeAvailable(laya)
        target_link_libraries(your_target laya::laya)
        ```

        ## System Requirements

        - C++20 compatible compiler
        - CMake 3.21 or later
        - SDL3 (automatically handled by laya)
        EOF

        cat > docs-build/mkdocs/docs/getting-started/quick-start.md << 'EOF'
        # Quick Start

        This guide will help you create your first laya application.

        ## Hello World

        Create a simple window that responds to close events:

        ```cpp
        #include <laya/laya.hpp>

        int main() {
            // Initialize SDL3 subsystems
            laya::context ctx;

            // Create a window
            laya::window window("Hello laya", {800, 600});

            // Create a renderer
            laya::renderer renderer(window);

            // Main loop
            bool running = true;
            while (running) {
                // Handle events
                for (const auto& event : laya::poll_events()) {
                    if (std::holds_alternative<laya::quit_event>(event)) {
                        running = false;
                    }
                }

                // Clear screen with dark blue
                renderer.clear(laya::color::from_hex(0x2E3440));

                // Present the frame
                renderer.present();
            }

            return 0;
        }
        ```

        ## Building

        ### CMakeLists.txt

        ```cmake
        cmake_minimum_required(VERSION 3.21)
        project(hello_laya)

        find_package(laya REQUIRED)

        add_executable(hello_laya main.cpp)
        target_link_libraries(hello_laya laya::laya)
        target_compile_features(hello_laya PRIVATE cxx_std_20)
        ```

        ### Build Commands

        ```bash
        mkdir build && cd build
        cmake ..
        cmake --build .
        ./hello_laya
        ```

        ## Next Steps

        - [Basic Graphics Example](../examples/basic-graphics.md)
        - [Event Handling Guide](../examples/event-handling.md)
        - [API Reference](../api/index.md)
        EOF

        cat > docs-build/mkdocs/docs/getting-started/building.md << 'EOF'
        {!README.md!}
        EOF

        # Create API reference pages
        cat > docs-build/mkdocs/docs/api/index.md << 'EOF'
        # API Reference

        Complete API documentation is available in the [Doxygen documentation](../doxygen/html/index.html).

        ## Core Modules

        - **[Core](core.md)** - Initialization, error handling, and basic types
        - **[Graphics](graphics.md)** - Windows, rendering, textures, and surfaces
        - **[Input](input.md)** - Event handling, keyboard, mouse, and gamepad input
        - **[Audio](audio.md)** - Audio devices, playback, and streaming

        ## Quick Reference

        ### Initialization

        ```cpp
        laya::context ctx;  // Initialize SDL3
        ```

        ### Window Management

        ```cpp
        laya::window window("Title", {800, 600});
        window.show();
        window.set_position({100, 100});
        ```

        ### Rendering

        ```cpp
        laya::renderer renderer(window);
        renderer.clear(laya::color::black());
        renderer.draw_rect({{10, 10}, {100, 50}});
        renderer.present();
        ```

        ### Event Handling

        ```cpp
        for (const auto& event : laya::poll_events()) {
            std::visit([](const auto& e) {
                // Handle event
            }, event);
        }
        ```
        EOF

        # Create placeholder pages
        for page in api/core.md api/graphics.md api/input.md api/audio.md examples/hello-world.md examples/basic-graphics.md examples/event-handling.md contributing/development.md contributing/testing.md; do
          mkdir -p "docs-build/mkdocs/docs/$(dirname "$page")"
          echo "# $(basename "$page" .md | tr '-' ' ' | sed 's/\b\w/\U&/g')" > "docs-build/mkdocs/docs/$page"
          echo "" >> "docs-build/mkdocs/docs/$page"
          echo "Documentation coming soon..." >> "docs-build/mkdocs/docs/$page"
        done

    - name: Build Doxygen documentation
      run: |
        doxygen Doxyfile

    - name: Build MkDocs documentation
      run: |
        cd docs-build/mkdocs
        cp ../../mkdocs.yml .
        cp -r ../../docs ./ || true
        cp ../../README.md docs/
        cp ../../CONTRIBUTING.md docs/
        mkdocs build --site-dir ../site

    - name: Copy Doxygen to site
      run: |
        cp -r docs-build/doxygen/html docs-build/site/doxygen

    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs-build/site/
        retention-days: 30

    - name: Upload Pages artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs-build/site/

  deploy:
    name: Deploy to GitHub Pages
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  link-check:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.event_name == 'pull_request'

    steps:
    - name: Download documentation
      uses: actions/download-artifact@v4
      with:
        name: documentation
        path: site

    - name: Install link checker
      run: |
        npm install -g markdown-link-check

    - name: Check links
      run: |
        # Check markdown files for broken links
        find site -name "*.md" -exec markdown-link-check {} \; || true

        # Check HTML files for broken internal links
        find site -name "*.html" -exec grep -l "href=" {} \; | head -10 | while read file; do
          echo "Checking links in $file"
          # Simple link validation - can be enhanced
          grep -o 'href="[^"]*"' "$file" | grep -v "^href=\"http" | head -5 || true
        done
