name: Static Analysis

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

env:
  ACT: 'false'

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true  # Only doctest submodule

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Add repositories for newer compilers
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main"
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy-18 \
          clang-18 \
          gcc-13 \
          g++-13 \
          cppcheck \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          libx11-dev \
          libxext-dev \
          libxrandr-dev \
          libxcursor-dev \
          libxfixes-dev \
          libxi-dev \
          libxss-dev \
          libwayland-dev \
          libxkbcommon-dev \
          libdrm-dev \
          libgl1-mesa-dev \
          libgles2-mesa-dev \
          libegl1-mesa-dev \
          libdbus-1-dev \
          libudev-dev

    - name: Run clang-tidy
      run: |
        # Set up environment to use GCC 13
        export CC=gcc-13
        export CXX=g++-13

        # Create compile_commands.json
        cmake -B build \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DCMAKE_CXX_STANDARD=20 \
          -DCMAKE_CXX_STANDARD_REQUIRED=ON

        # Run clang-tidy on headers in include/ and source files in src/
        find include -type f -name "*.hpp" | \
        xargs clang-tidy-18 -p build --config-file=.clang-tidy > clang-tidy-report.txt 2>&1 || true

        find src -type f -name "*.cpp" | \
        xargs clang-tidy-18 -p build --config-file=.clang-tidy >> clang-tidy-report.txt 2>&1 || true

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --suppress=unusedFunction \
          src/ include/ 2> cppcheck-report.xml || true

    - name: Upload static analysis results
      if: ${{ env.ACT != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-results
        path: |
          clang-tidy-report.txt
          cppcheck-report.xml
        retention-days: 30
